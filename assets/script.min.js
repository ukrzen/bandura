'use strict';Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]};$(function(){function canUseWebP(){var elem=document.createElement('canvas');if(!!(elem.getContext&&elem.getContext('2d'))){return elem.toDataURL('image/webp').indexOf('data:image/webp')==0}
    return!1}
    $("body").addClass(canUseWebP()?"webp":'no-webp');var soundsMap={};var sounds={};var hangSvgLoaded=!1;var isTouch="ontouchstart" in window;var iOS=navigator.userAgent.match(/iPhone|iPad|iPod/i);var simplified=location.search.indexOf("simple")!=-1;Howler.mobileAutoEnable=!1;var isMobile=isTouch;var notesPlayed=0;var isDefaultInstrument=location.search.indexOf("v=2")==-1;var MIN_COUNT_LAYER=isDefaultInstrument?4:1;var FIRST_LAYER=isDefaultInstrument?3:-1;var currentLine=0;$("body").addClass(isTouch?"mobile":"desktop");if(simplified)$("body").addClass("simple");if(isTouch)$("body").addClass(iOS?"ios":"non-ios");document.body.addEventListener('touchmove',function(e){e.preventDefault()},{passive:!1});var isPlaying={};var readyToPlay=!1;$("body").on(isTouch?'touchstart':"mousedown",".line",function(event){play(this,!0);event.stopImmediatePropagation()});if(!isTouch){$("body").on("mouseover",".line",function(event){if(event.buttons||typeof event.buttons=='undefined'&&event.originalEvent.which!==0){play(this);event.stopImmediatePropagation()}})}
    var recordTimestamp,recordData,isRecording=!1;function now(){return window.performance&&window.performance.now&&window.performance.timing&&window.performance.timing.navigationStart?window.performance.now()+window.performance.timing.navigationStart:Date.now()}
    function record(){recordData=[];isRecording=!0;recordTimestamp=now()}
    function stopRecord(){isRecording=!1}
    function playRecord(data,pos){for(var i=0;i<data.length;i++){(function(){var currentEvent=data[i];setTimeout(function(){var e=jQuery.Event(currentEvent[0]>0?'keydown':'keyup');e.keyCode=Math.abs(currentEvent[0]);$(window).trigger(e)},currentEvent[1])})()}}
    function play(el,forcePlay){var note=parseInt($(el).data("note"));$(el).addClass("clicked");isPlaying[note]=!0;soundsMap[note].play();notesPlayed++;if(notesPlayed>10)$("#sound-help").addClass("hidden");$(this).one('animationend webkitAnimationEnd MSAnimationEnd oAnimationEnd',function(e){$(el).removeClass("clicked");isPlaying[note]=!1})}
    $("#sound-help").appendTo(".container");var loadedNotes=21;function countHandler(){loadedNotes--;if(loadedNotes==0){$(".hello.screen").addClass("ready");$(".bandura.screen").addClass("ready");$(".not-ready").removeClass("not-ready");readyToPlay=!0;if(location.hash){recordData=JSON.parse(atob(location.hash.slice(1)));playRecord(recordData)}}}
    for(var note=1;note<=21;note++){soundsMap[note]=new Howl({src:["samples/mp3/"+note+".mp3","samples/ogg/"+note+".ogg"],pool:32,onload:countHandler,onloaderror:function onloaderror(){soundsMap[note]=null;countHandler()}})};$(".sound.screen").on("click",function(){$(".sound.screen").addClass("hidden");$("#sound-help").removeClass("hidden")});$(".hello.screen").on("click",function(){if(readyToPlay){$(".hello.screen").addClass("hidden");if(isMobile){$(".sound.screen").addClass("ready")}}});$(".help.screen").on("click",function(){$(".help.screen").addClass("hidden")});$("#sound-help").on("click",function(){$(".help.screen").removeClass("hidden")});var keyMap={65:1,83:2,68:3,70:4,71:5,72:6,74:7,75:8,76:9,186:10,222:11,90:12,88:13,67:14,86:15,66:16,78:17,77:18,188:19,190:20,191:21};var pressedKeys={};$(".bandura .info").on('click',function(){$(".screen.info").removeClass('hidden').addClass('ready')});$(".screen.info").on('click',function(){$(".screen.info").removeClass('ready');$('.screen.info').one('transitionend',function(e){$(this).addClass("hidden")})});$(".screen .record").on('click',function(){$(".screen .record").toggleClass('active');if(isRecording){stopRecord();$(".screen .play").removeClass('disabled')}else{record()}});$(".screen .play").on('click',function(){playRecord(recordData)});$(window).on("keydown",function(e){pressedKeys[e.keyCode]=!0;if(isRecording){var nowValue=now();recordData.push([e.keyCode,Math.round(nowValue-recordTimestamp,3)])}});$(window).on("keyup",function(e){pressedKeys[e.keyCode]=!1;if(isRecording){var nowValue=now();recordData.push([-e.keyCode,Math.round(nowValue-recordTimestamp,3)])}});$(window).on("keydown",function(e){Object.keys(keyMap).forEach(function(key){if(pressedKeys[key]){$(".line[data-note="+keyMap[key]+"]").trigger('mousedown').trigger('touchstart')}})});var strings={1:{x:203-6,width:4},2:{x:227-6,width:4},3:{x:252-6,width:2.5},4:{x:275-6,width:2.5},5:{x:292,width:1.5,top:46,deg:0.1},6:{x:317,width:1.5,top:78,deg:0.9},7:{x:342,width:1.5,top:110,deg:1.7},8:{x:366,width:1.5,deg:2.5,top:140},9:{x:394,width:1.5,deg:3.7,top:172},10:{x:415,width:1.5,deg:5,top:204},11:{x:441,width:1.5,deg:6.5,top:237},12:{x:465,width:1.5,deg:8.5,top:267},13:{x:487,width:1.5,deg:10.5,top:296},14:{x:508,width:1.5,deg:13,top:330,bottom:-11},15:{x:531,width:1.5,deg:15,top:360,bottom:-11},16:{x:554-3,width:1.5,deg:17,top:393,bottom:-11},17:{x:569,width:1,deg:19,top:428,bottom:-11},18:{x:587,width:1,deg:21,top:466,bottom:-11},19:{x:601,width:1,deg:23.5,top:508,bottom:-21},20:{x:615,width:1,deg:25.9,top:546,bottom:-21},21:{x:626,width:1,deg:28.2,top:590,bottom:-21}};for(var i=1;i<=21;i++){var line=$("<div class='line' onclick=''><div>  <div></div>  </div></div>");var string=strings[i];var width=string.width;line.css("left",string.x+"px");line.css("top",(string.top||-20)+"px");line.css("bottom","0px");line.css("width",width+"px");if(string.deg)line.css("transform","rotate("+string.deg+"deg)");if(string.bottom)line.css("bottom",string.bottom+"px");line.attr("data-note",i);line.appendTo($(".content "))}
    if(isTouch){$("body").on('touchmove','.line',function(event){var el=$(document.elementFromPoint(event.originalEvent.touches[0].pageX,event.originalEvent.touches[0].pageY));if(el.length){if(!el.is('.line')){el=el.parents('.line')}}
        var newLine=parseInt($(el).data("note"));if(newLine&&newLine!=currentLine){currentLine=newLine;play(el)}
        event.preventDefault()})}})